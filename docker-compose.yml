---
# Docker Compose for Grommunio (Open Circle Fork)
#
# Copy this file and adjust the values to match your environment.
# See var.env for the application-level configuration.

name: grommunio

# Custom network so all services can communicate using a FQDN
networks:
    grommunio:
        driver: bridge
        enable_ipv6: true
        ipam:
            config:
                - subnet: 172.28.0.0/24
                  gateway: 172.28.0.1
                - subnet: "fd00:1::/64"
                  gateway: "fd00:1::1"

volumes:
  gromox_services:
  cert_data:
  gromox_mysql_data:
  archive_mysql_data:
  grommunio-admin-api:
  grommunio-antispam:
  grommunio-dav:
  opensuse_data:
  gromox:
  gromox_config:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/gromox_config
  variables_data:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/variables_data
  gromox_letsencrypt:
    driver: local
    driver_opts:
      type: none
      o: bind
      device: ./data/gromox_letsencrypt

services:
    gromox-db:
        image: mariadb:10
        container_name: gromox-db
        environment:
            TZ: Europe/Zurich
            MARIADB_ROOT_PASSWORD: changeme_root_password
            MARIADB_DATABASE: grommunio
            MARIADB_USER: grommunio
            MARIADB_PASSWORD: changeme_db_password
        volumes:
            - gromox_mysql_data:/var/lib/mysql
        restart: unless-stopped
        healthcheck:
            test: mariadb --host=localhost --user=$${MARIADB_USER} --password=$${MARIADB_PASSWORD} -e 'SELECT 1;'
            interval: 30s
            timeout: 10s
            retries: 5
        dns:
          - 127.0.0.11
          - 8.8.8.8
        networks:
            grommunio:
                aliases:
                    - gromox-db

    archive-db:
        image: mariadb:10
        container_name: archive-db
        environment:
            TZ: Europe/Zurich
            MARIADB_ROOT_PASSWORD: changeme_archive_root_password
            MARIADB_DATABASE: groarchive
            MARIADB_USER: groarchive
            MARIADB_PASSWORD: changeme_archive_db_password
        volumes:
            - archive_mysql_data:/var/lib/mysql
        restart: unless-stopped
        healthcheck:
            test: mariadb --host=localhost --user=$${MARIADB_USER} --password=$${MARIADB_PASSWORD} -e 'SELECT 1;'
            interval: 30s
            timeout: 10s
            retries: 5
        dns:
          - 127.0.0.11
          - 8.8.8.8
        networks:
            grommunio:
                aliases:
                    - archive-db

    gromox-core:
        image: ghcr.io/open-circle-ltd/gromox-core:latest
        restart: unless-stopped
        privileged: true
        command: ["/sbin/init", "--ignore-audit"]
        cap_add:
            - SYS_ADMIN
            - SYS_RESOURCE
        volumes:
          - opensuse_data:/data
          - variables_data:/home/vars
          - cert_data:/etc/grommunio-common/ssl
          - gromox_services:/home/gromox-services
          - grommunio-admin-api:/var/lib/grommunio-admin-api
          - grommunio-antispam:/var/lib/grommunio-antispam
          - grommunio-dav:/var/lib/grommunio-dav
          - gromox:/var/lib/gromox
          - gromox_config:/etc/gromox
          - gromox_letsencrypt:/etc/letsencrypt
        ports:
          - "25:25"     # SMTP
          - "80:80"     # HTTP / Letsencrypt challenges
          - "443:443"   # HTTPS / Grommunio Web
          - "465:465"   # SMTPS
          - "587:587"   # SMTP Submission
          - "110:110"   # POP3
          - "143:143"   # IMAP
          - "993:993"   # IMAPS
          - "995:995"   # POP3S
          - "8443:8443" # Grommunio Admin
        tty: true
        stdin_open: true
        dns:
          - 127.0.0.11
          - 8.8.8.8
        networks:
          grommunio:
            aliases:
              - gromox-core
        env_file:
          - ./data/variables_data/var.env
        depends_on:
          gromox-db:
            condition: service_healthy
          archive-db:
            condition: service_healthy
